<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <link rel="stylesheet" href="converter.css">
    <title>Miplatform Nexacro Dataset Converter</title>
</head>

<body class="bg-light">
    <div class="container">
        <div class="py-5 text-center">
            <h2>MiPlatform Dataset Converter</h2>
            <p class="lead">Miplatform Dataset XML 을 Nexacro Dataset XML 로 변환 합니다. 왼쪽 Box 에 MiPlatform Dataset XML 문자열 입력 후 '변환' 버튼을 클릭하면 오른쪽 Box 에 Naxacro 문법으로 변환된 XML 문자열이 출력됩니다.</p>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="address">MiPlatform</label>
                    <textarea class="form-control" id="miplatformDataset" rows="10"></textarea>
                </div>
                <button class="btn btn-convert btn-primary float-right" data-toggle="tooltip" title="Nexacro Dataset 변환">변환</button>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="address">Nexacro</label>
                    <textarea class="form-control" id="nexacroDataset" rows="10"></textarea>
                </div>
                <button class="btn btn-clipboard btn-primary float-right" data-toggle="tooltip" data-clipboard-target="#nexacroDataset" title="클립보드로 복사">복사</button>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script>
        $('[data-toggle="tooltip"]').tooltip().on("mouseleave", function() {
            $(this).tooltip("hide")
        })

        var e = new ClipboardJS('.btn-clipboard');
        e.on('success', function(e) {
            $(e.trigger).attr("title", "복사됨!").tooltip("_fixTitle").tooltip("show").attr("title", "클립보드로 복사").tooltip("_fixTitle");
            e.clearSelection();
        });
        e.on('error', function(e) {
            var t = /Mac/i.test(navigator.userAgent) ? "⌘" : "Ctrl-";
            var n = "Press " + t + "C to copy";
            $(e.trigger).attr("title", n).tooltip("_fixTitle").tooltip("show").attr("title", "클립보드로 복사").tooltip("_fixTitle")
        });

        $('.btn-convert').on('click', function(event) {
            var xmlDoc = new DOMParser().parseFromString($("#miplatformDataset").val(), "text/xml");
            var dsNodes = xmlDoc.getElementsByTagName("Dataset");
            var strBuffer = "";
            for (var i = 0; i < dsNodes.length; i++) {
                var dsObj = parseDataset(dsNodes[i]);
                strBuffer += convertDataset(dsObj) + '\n';
            };
            $("#nexacroDataset").val(strBuffer);
        });

        /**
         * Dataset Object 를 Nexacro Dataset XML 로 변환
         */
        function convertDataset(dsObj) {
            var xmlString = "<root></root>";
            var parser = new DOMParser();
            var xmlDoc = parser.parseFromString(xmlString, "text/xml");

            //Dataset
            var dsNode = xmlDoc.createElement("Dataset");
            dsNode.setAttribute("id", dsObj.id);
            var colinfoNode = xmlDoc.createElement("ColumnInfo");
            dsNode.appendChild(colinfoNode);
            var rowsNode = xmlDoc.createElement("Rows");
            dsNode.appendChild(rowsNode);

            //ColumnInfo
            for (var i = 0; i < dsObj.columns.length; i++) {
                var colNode = xmlDoc.createElement("Column");
                var colObj = dsObj.columns[i];
                for (var name in colObj) {
                    colNode.setAttribute(name, colObj[name]);
                }
                colinfoNode.appendChild(colNode);
            }

            //Rows
            for (var i = 0; i < dsObj.rows.length; i++) {
                var rowNode = xmlDoc.createElement("Row");
                rowsNode.appendChild(rowNode);

                var rowObj = dsObj.rows[i];
                for (var j = 0; j < rowObj.cols.length; j++) {
                    var colNode = xmlDoc.createElement("Col");
                    rowNode.appendChild(colNode);

                    var colObj = rowObj.cols[j];
                    colNode.setAttribute("id", colObj.id);
                    colNode.textContent = colObj.value;
                }
            }
            xmlDoc.documentElement.appendChild(dsNode);

            return formatXml(xmlDoc.querySelector("root").innerHTML);
        }

        function formatXml(xml) {
            var formatted = '';
            var reg = /(>)(<)(\/*)/g;
            xml = xml.replace(reg, '$1\r\n$2$3');
            var pad = 0;
            jQuery.each(xml.split('\r\n'), function(index, node) {
                var indent = 0;
                if (node.match(/.+<\/\w[^>]*>$/)) {
                    indent = 0;
                } else if (node.match(/^<\/\w/)) {
                    if (pad != 0) {
                        pad -= 1;
                    }
                } else if (node.match(/^<\w[^>]*[^\/]>.*$/)) {
                    indent = 1;
                } else {
                    indent = 0;
                }

                var padding = '';
                for (var i = 0; i < pad; i++) {
                    padding += '  ';
                }

                formatted += padding + node + '\r\n';
                pad += indent;
            });

            return formatted;
        }

        /**
         * MiPlatform Dataset XML 을 파싱하여 Dataset Object 로 변환
         */
        function parseDataset(ds) {
            var dsObj = {
                columns: [],
                rows: []
            };
            dsObj.id = ds.getAttribute("Id");

            var cols = ds.querySelectorAll("Contents > colinfo");
            for (var i = 0; i < cols.length; i++) {
                dsObj.columns[i] = parseColumn(cols[i]);
            }

            var records = ds.querySelectorAll("Contents > record");
            for (var i = 0; i < records.length; i++) {
                dsObj.rows[i] = parseRecord(records[i]);
            }
            console.log(JSON.stringify(dsObj));
            return dsObj;
        }

        /**
         * colinfo XML 노드를 column Object 로 변환
         */
        function parseColumn(colinfo) {
            var colObj = {};
            var attrs = colinfo.attributes;
            for (var i = 0; i < attrs.length; i++) {
                colObj[attrs[i].name] = attrs[i].value;
            }
            return colObj;
        }

        /**
         * record XML 노드를 row Object 로 변환
         */
        function parseRecord(record) {
            var rowObj = {
                cols: []
            };
            var nodes = record.children;
            for (var i = 0; i < nodes.length; i++) {
                rowObj.cols[i] = {
                    id: nodes[i].nodeName,
                    value: nodes[i].textContent
                };
            }
            return rowObj;
        }
    </script>
</body>

</html>